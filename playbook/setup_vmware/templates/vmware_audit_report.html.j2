<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Rapport d'audit VMware</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; }
    th { background-color: #f2f2f2; text-align: left; }
    .section { margin-bottom: 40px; }
    .tag { font-size: 11px; color: #555; }
  </style>
</head>
<body>
  <h1>Rapport d'audit VMware</h1>
  <p class="tag">
    Généré par Ansible – vCenter YUCELSAN : {{ vcenter_hostname | default('N/A') }}
  </p>

  <!-- 1. VMs -->
  <div class="section">
    <h2>1. Machines virtuelles</h2>
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Power</th>
          <th>OS</th>
          <th>CPU</th>
          <th>RAM (Mo)</th>
          <th>IP(s)</th>
          <th>Hostname invité</th>
        </tr>
      </thead>
      <tbody>
      {% for vm in vm_info.virtual_machines | default([]) %}
        {% if vm %}
        {% set d = vm_details.get(vm.get('guest_name', ''), {}) %}
        <tr>
          <td>{{ vm.get('guest_name', '') }}</td>
          <td>{{ vm.get('power_state', '') }}</td>
          <!-- OS -->
          <td>
            {{ d.get('hw_guest_full_name', vm.get('guest_fullname', '')) }}
          </td>
          <!-- CPU -->
          <td>{{ d.get('hw_processor_count', '') }}</td>
          <!-- RAM (Mo) -->
          <td>{{ d.get('hw_memtotal_mb', '') }}</td>
          <!-- IP(s) -->
          <td>
            {% if d.get('ipv4') %}
              {% if d.get('ipv4') is string %}
                {{ d.get('ipv4') }}
              {% else %}
                {{ d.get('ipv4') | join(', ') }}
              {% endif %}
            {% elif vm.get('ip_address') %}
              {{ vm.get('ip_address') }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ vm.get('guest_name', '') }}</td>
        </tr>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 2. Datastores -->
  <div class="section">
    <h2>2. Datastores</h2>
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Type</th>
          <th>Capacité (Go)</th>
          <th>Utilisé (Go)</th>
          <th>Libre (Go)</th>
        </tr>
      </thead>
      <tbody>
      {% for ds in datastore_info.datastores | default([]) %}
        {% if ds %}
        {% set cap = (ds.get('capacity', 0) | int) // (1024*1024*1024) %}
        {% set free = (ds.get('free_space', 0) | int) // (1024*1024*1024) %}
        {% set used = cap - free %}
        <tr>
          <td>{{ ds.get('name', '') }}</td>
          <td>{{ ds.get('type', '') }}</td>
          <td>{{ cap }}</td>
          <td>{{ used }}</td>
          <td>{{ free }}</td>
        </tr>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>
  </div>


</body>
</html>
